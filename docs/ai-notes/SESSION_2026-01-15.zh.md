# 2026-01-15 AI 对话学习记录（可发布版）

> 说明：本文件是对 AI 协作开发过程的“可发布纪要”，避免包含任何敏感信息（token/密码/内网地址等）。

## 背景

仓库：`1wlgame`（Node.js ESM + Express + Socket.IO + Canvas2D 客户端）。

目标是把当前原型闭环做扎实：

- P0 可玩闭环（吃豆成长、PVP 吞噬、死亡重生、HUD）
- 状态同步优化（delta/binary）
- bots 测试稳定
- 补齐架构数据流文档
- 修复 HUD 遮挡问题

## Roadmap 完成度（当日）

- P0（Playable loop）：已完成
  - 吞噬/成长规则（豆子 + 玩家）
  - 死亡与重生闭环
  - 基础 HUD（人数/延迟/FPS）
- P1/P2（后续）：分裂/喷射/virus/皮肤/设置面板等待做

## 关键决策（Design decisions）

### 1) 体积不再无限增长：上限 + 吞噬能力“层级化”

问题：如果体积无限增长，地图视野/碰撞判定/数值会失控；同时不希望通过镜头缩放来表达强度。

方案：

- **物理半径**有上限（`maxRadius`），避免无限放大。
- 超过阈值后，吞噬能力通过“score 派生的 tier”继续增长（不修改协议字段）。
- 客户端仅做轻量视觉提示（halo），不改 HUD 行数/信息结构。

对应提交：3100b30

### 2) bots 测试不再依赖 state 内的 meta 字段

问题：测试最初假设 `state.players` 含 `isBot`，但服务端把 meta 放在 `players:meta`，且 `state` 可能是 delta 帧。

方案：

- 测试脚本同时订阅 `players:meta` + delta `state`，自己维护 pid->player 状态缓存。
- 用 meta 与 state 的 join 结果判断 bot 是否移动与回收。

对应提交：3100b30

### 3) 文档化闭环架构数据流

目标：把“控制面（Socket.IO 事件）+ 状态面（state 帧）”的闭环画出来，便于后续扩展 rules/玩法。

对应提交：71eaf76

### 4) HUD 显示/隐藏遮挡修复

问题：HUD 面板与 HUD 按钮都在左上固定定位，打开后会覆盖按钮。

方案：

- 在 CSS 里为 HUD 按钮预留垂直空间（`--hud-fab-offset`），使面板始终显示在按钮下方。

对应提交：f245236

## 变更按文件归档（Changes by file)

> 此处只记录关键位置和目的，不贴大段代码。

- `server/src/state.js`
  - 增加 `maxRadius` 上限
  - 增加 score->tier 计算
  - PVP 吞噬判定引入 tier 影响（吃人阈值/有效半径等）
- `server/public/client.js`
  - 用 score 计算 tier（与规则参数一致）
  - near-cap & tier>0 时渲染 halo
- `server/public/config.json`
  - 暴露规则调参项（agar-lite/agar-advanced）
- `server/scripts/test_bots.mjs`
  - 用 `players:meta` + delta `state` 合并判断 bots 行为
- `docs/DATA_FLOW.md` / `docs/DATA_FLOW.zh.md`
  - Mermaid：总体流、加入/游玩序列、死亡重生闭环、控制面/状态面说明
- `docs/ARCHITECTURE.md`
  - 链接 Data Flow 文档
- `server/public/style.css`
  - HUD 面板下移，避免遮挡 HUD 按钮

## 验证与回归（Validation）

- `npm run test:bots`：多次运行通过，避免 timeout。
- `GET /healthz`：健康检查 OK（用于线上探活）。
- 手工验证：HUD 打开/关闭时按钮可点，面板在按钮下方。

## 踩坑与经验（Gotchas）

- **协议层面**：`players:meta` 与 `state` 是两路信息，不能在测试里假设 state 带 meta。
- **delta 帧**：消费端要能处理 `playersD/playersGone`。
- **UI 细节**：移动端视口建议用 `svh/dvh`，并关注 safe-area。

## 线上部署下一步建议（To deploy next）

- 优先做 Docker + 反代（Caddy/Nginx）+ HTTPS。
- 明确环境变量：`HOST`/`PORT`/`REDIS_URL`。
- 生产加固：基本限流、日志滚动、进程守护、探活。
