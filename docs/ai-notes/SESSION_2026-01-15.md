# 2026-01-15 AI Learning Record (Publishable)

> This is a publishable summary of the AI-assisted dev session. It intentionally avoids secrets (tokens/passwords/private URLs).

## Context

Repo: `1wlgame` (Node.js ESM + Express + Socket.IO + Canvas2D client).

Focus: harden the current closed-loop prototype:

- P0 playable loop (growth/eat, death/respawn, HUD)
- State streaming (delta/binary formats)
- Stabilize the bots integration test
- Add closed-loop data flow documentation
- Fix HUD toggle/panel overlap

## Roadmap status (that day)

- P0 (Playable loop): done
  - Eat/growth rules (pellets + players)
  - Death + respawn loop
  - Basic HUD (players/ping/FPS)
- P1/P2: pending (split/eject/virus/skins/settings panel)

## Key decisions

### 1) Prevent infinite size: radius cap + score-derived power tiers

Problem: unlimited growth breaks balance and camera/physics; we also didn’t want camera zoom to represent power.

Approach:

- Cap physical radius (`maxRadius`).
- After reaching the cap, keep “eat power” progressing via a **tier derived from score** (no protocol changes).
- Client shows a subtle halo effect near the cap (no HUD schema changes).

Commit: 3100b30

### 2) Make `test:bots` match the real protocol shape

Problem: the test assumed `isBot` lives in `state.players`, but the server keeps meta in `players:meta`, and `state` may be delta-only.

Fix:

- Join `players:meta` with delta `state` frames.
- Maintain a pid->state cache locally in the test.

Commit: 3100b30

### 3) Document the closed-loop data flow

Goal: clarify control-plane vs state-plane and the join requirement (`players:meta` + `state`).

Commit: 71eaf76

### 4) HUD overlap fix

Problem: HUD panel could cover the fixed HUD toggle button.

Fix:

- Reserve vertical space for the toggle button via CSS (`--hud-fab-offset`) so the panel always opens below it.

Commit: f245236

## Changes by file (high level)

- `server/src/state.js`: radius cap + power tiers + tier-aware PVP eat checks
- `server/public/client.js`: tier computation + halo rendering near cap
- `server/public/config.json`: expose tuning knobs
- `server/scripts/test_bots.mjs`: stable join of meta + delta state
- `docs/DATA_FLOW.md`, `docs/DATA_FLOW.zh.md`: Mermaid flow/sequence diagrams
- `docs/ARCHITECTURE.md`: link to data flow docs
- `server/public/style.css`: HUD panel offset fix

## Validation

- `npm run test:bots` passed repeatedly.
- `GET /healthz` OK.
- Manual UI check: HUD toggle remains clickable; panel opens below the button.

## Gotchas

- Do not assume meta fields are inside `state` frames.
- Delta frames require correct application of `playersD/playersGone`.
- Mobile viewport + safe-area need explicit handling (`svh/dvh`).

## Next: deployment

- Prepare a production bundle (Docker + reverse proxy + HTTPS) or a systemd-based setup.
- Standardize env vars: `HOST`, `PORT`, `REDIS_URL`.
- Add baseline hardening: rate limiting, process supervision, health checks.
